<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kompetenzen Import - Digitaler Kompetenzpass</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
        }

        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
        }

        .info-box {
            background: #f0f4ff;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ed8936;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .success-box {
            background: #d4edda;
            border-left: 4px solid #48bb78;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }

        .error-box {
            background: #f8d7da;
            border-left: 4px solid #f56565;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            display: none;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
            transition: transform 0.2s;
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .log {
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #ddd;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ Kompetenzen Import</h1>
        <p class="subtitle">Importiere Lehrplan-Kompetenzen in Firestore</p>

        <!-- Login-Bereich -->
        <div id="loginSection">
            <div class="info-box">
                <strong>üîê Authentifizierung erforderlich:</strong> Bitte melde dich als Lehrer an, um den Import durchzuf√ºhren.
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Lehrer E-Mail:</label>
                <input type="email" id="teacherEmail" placeholder="lehrer@schule.ch"
                    style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;"
                    onkeypress="if(event.key==='Enter') loginTeacher()">
            </div>

            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Passwort:</label>
                <input type="password" id="teacherPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                    style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;"
                    onkeypress="if(event.key==='Enter') loginTeacher()">
            </div>

            <button class="btn" id="loginBtn" onclick="loginTeacher()">
                üîì Als Lehrer anmelden
            </button>
        </div>

        <!-- Import-Bereich (hidden bis Login) -->
        <div id="importSection" style="display: none;">
            <div class="success-box" style="display: block;">
                <strong>‚úÖ Angemeldet als:</strong> <span id="loggedInUser"></span>
            </div>

            <div class="info-box">
                <strong>‚ÑπÔ∏è Info:</strong> Dieses Tool importiert 87 Kompetenzstufen aus der CSV-Datei in drei hierarchische Firestore-Collections:
                <ul style="margin-top: 10px; margin-left: 20px;">
                    <li><strong>competencyAreas</strong> - 3 Kompetenzbereiche</li>
                    <li><strong>competencies</strong> - √úbergeordnete Kompetenzen</li>
                    <li><strong>competencyLevels</strong> - Konkrete Kompetenzstufen</li>
                </ul>
            </div>

            <div class="warning-box">
                <strong>‚ö†Ô∏è Warnung:</strong> Dieser Import l√∂scht alle bestehenden Kompetenzen! Dieser Vorgang kann nicht r√ºckg√§ngig gemacht werden.
            </div>
        </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="statAreas">0</div>
                    <div class="stat-label">Bereiche</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statCompetencies">0</div>
                    <div class="stat-label">Kompetenzen</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="statLevels">0</div>
                    <div class="stat-label">Stufen</div>
                </div>
            </div>

            <button class="btn" id="importBtn" onclick="startImport()">
                Import starten
            </button>
        </div>

        <div class="success-box" id="successBox">
            <strong>‚úÖ Erfolg!</strong> <span id="successMessage"></span>
        </div>

        <div class="error-box" id="errorBox">
            <strong>‚ùå Fehler!</strong> <span id="errorMessage"></span>
        </div>

        <div class="progress" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill">0%</div>
            </div>
            <div id="progressText" style="text-align: center; color: #666;"></div>
        </div>

        <div class="log" id="logContainer"></div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // Firebase-Konfiguration (gleich wie in index.html)
        const firebaseConfig = {
            apiKey: "AIzaSyBfXZSQ5SPrJ-cNRRuggTSiTV_UBt14g9s",
            authDomain: "kompetenzpass.firebaseapp.com",
            projectId: "kompetenzpass",
            storageBucket: "kompetenzpass.firebasestorage.app",
            messagingSenderId: "46794299225",
            appId: "1:46794299225:web:fa145209709de27adb9e48",
            measurementId: "G-YNSXPTK0PH"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        window.db = db;
        window.auth = auth;
        let currentUser = null;

        // Logging-Funktion
        function log(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            logContainer.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `<span style="color: #999;">[${timestamp}]</span> ${message}`;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            console.log(message);
        }

        function showSuccess(message) {
            const box = document.getElementById('successBox');
            document.getElementById('successMessage').textContent = message;
            box.style.display = 'block';
            document.getElementById('errorBox').style.display = 'none';
        }

        function showError(message) {
            const box = document.getElementById('errorBox');
            document.getElementById('errorMessage').textContent = message;
            box.style.display = 'block';
            document.getElementById('successBox').style.display = 'none';
        }

        function updateProgress(percent, text) {
            const progressContainer = document.getElementById('progressContainer');
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');

            progressContainer.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressFill.textContent = Math.round(percent) + '%';
            progressText.textContent = text;
        }

        function updateStats(areas, competencies, levels) {
            document.getElementById('statAreas').textContent = areas;
            document.getElementById('statCompetencies').textContent = competencies;
            document.getElementById('statLevels').textContent = levels;
        }

        // CSV-Parser
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const rows = [];
            let currentRow = '';
            let inQuotes = false;

            for (const line of lines) {
                for (const char of line) {
                    if (char === '"') inQuotes = !inQuotes;
                }
                currentRow += (currentRow ? '\n' : '') + line;
                if (!inQuotes) {
                    if (currentRow.trim()) rows.push(currentRow);
                    currentRow = '';
                }
            }

            return rows.map(row => {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < row.length; i++) {
                    const char = row[i];
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                result.push(current.trim());
                return result;
            });
        }

        // Klassenstufen parsen
        function parseGrades(gradeString) {
            if (!gradeString) return [];
            return gradeString.split(',').map(g => g.trim());
        }

        // Zyklen parsen
        function parseCycles(cycleString) {
            if (!cycleString) return [];
            return cycleString.split(',').map(c => c.trim());
        }

        // Daten strukturieren
        function structureData(rows) {
            const areas = new Map();
            const competencies = new Map();
            const levels = [];

            // Skip header row
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const [lpCode, areaName, competencyName, levelDesc, cycleStr, gradeStr, isBasic] = row;

                if (!lpCode || !areaName) continue;

                // Kompetenzbereich
                if (!areas.has(areaName)) {
                    const emoji = areaName === 'Medien' ? 'üì±' :
                                 areaName === 'Informatik' ? 'üíª' : 'üéØ';
                    areas.set(areaName, {
                        id: areaName.toLowerCase(),
                        name: areaName,
                        emoji: emoji,
                        order: areas.size + 1
                    });
                }

                // Kompetenz (LP Code ohne Suffix, z.B. IB.1.1)
                const lpPrefix = lpCode.substring(0, lpCode.lastIndexOf('.'));
                if (!competencies.has(lpPrefix)) {
                    competencies.set(lpPrefix, {
                        id: lpPrefix.replace(/\./g, '-'),
                        areaId: areaName.toLowerCase(),
                        name: competencyName,
                        lpCodePrefix: lpPrefix,
                        order: competencies.size + 1
                    });
                }

                // Kompetenzstufe
                levels.push({
                    lpCode: lpCode,
                    competencyId: lpPrefix.replace(/\./g, '-'),
                    description: levelDesc,
                    cycles: parseCycles(cycleStr),
                    grades: parseGrades(gradeStr),
                    isBasicRequirement: isBasic?.toLowerCase() === 'ja',
                    order: levels.filter(l => l.competencyId === lpPrefix.replace(/\./g, '-')).length + 1
                });
            }

            return {
                areas: Array.from(areas.values()),
                competencies: Array.from(competencies.values()),
                levels: levels
            };
        }

        // Alte Daten l√∂schen
        async function deleteOldData() {
            log('üóëÔ∏è L√∂sche alte Kompetenzen...');

            const collections = ['competencyAreas', 'competencies', 'competencyLevels'];
            let deletedCount = 0;

            for (const collectionName of collections) {
                const snapshot = await getDocs(collection(db, collectionName));
                const batch = writeBatch(db);

                snapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                    deletedCount++;
                });

                if (snapshot.docs.length > 0) {
                    await batch.commit();
                    log(`  ‚úì ${snapshot.docs.length} Dokumente aus ${collectionName} gel√∂scht`);
                }
            }

            log(`‚úÖ ${deletedCount} alte Dokumente gel√∂scht`);
        }

        // Daten importieren
        async function importData(data) {
            let imported = 0;
            const total = data.areas.length + data.competencies.length + data.levels.length;

            // Bereiche importieren
            log('üìÅ Importiere Kompetenzbereiche...');
            for (const area of data.areas) {
                await setDoc(doc(db, 'competencyAreas', area.id), area);
                imported++;
                updateProgress((imported / total) * 100, `Importiere Bereiche (${area.name})`);
                log(`  ‚úì ${area.emoji} ${area.name}`);
            }
            updateStats(data.areas.length, 0, 0);

            // Kompetenzen importieren
            log('üìö Importiere Kompetenzen...');
            for (const comp of data.competencies) {
                await setDoc(doc(db, 'competencies', comp.id), comp);
                imported++;
                updateProgress((imported / total) * 100, `Importiere Kompetenzen (${comp.lpCodePrefix})`);
                log(`  ‚úì ${comp.lpCodePrefix}: ${comp.name.substring(0, 50)}...`);
            }
            updateStats(data.areas.length, data.competencies.length, 0);

            // Kompetenzstufen importieren
            log('‚≠ê Importiere Kompetenzstufen...');
            for (const level of data.levels) {
                const levelId = level.lpCode.replace(/\./g, '-');
                await setDoc(doc(db, 'competencyLevels', levelId), level);
                imported++;
                updateProgress((imported / total) * 100, `Importiere Stufen (${level.lpCode})`);
                if (imported % 10 === 0) {
                    log(`  ‚úì ${imported - data.areas.length - data.competencies.length}/${data.levels.length} Stufen importiert...`);
                }
            }
            updateStats(data.areas.length, data.competencies.length, data.levels.length);
            log(`‚úÖ Alle ${data.levels.length} Kompetenzstufen importiert`);

            updateProgress(100, 'Import abgeschlossen!');
        }

        // Login-Funktion
        window.loginTeacher = async function() {
            const email = document.getElementById('teacherEmail').value;
            const password = document.getElementById('teacherPassword').value;
            const loginBtn = document.getElementById('loginBtn');

            if (!email || !password) {
                showError('Bitte E-Mail und Passwort eingeben!');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Anmelden...';

            try {
                // Anmelden
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                currentUser = userCredential.user;

                // Pr√ºfen ob Lehrer
                const userDoc = await getDoc(doc(db, 'users', currentUser.uid));
                if (!userDoc.exists() || userDoc.data().role !== 'teacher') {
                    await auth.signOut();
                    currentUser = null;
                    showError('Nur Lehrer k√∂nnen den Import durchf√ºhren!');
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'üîì Als Lehrer anmelden';
                    return;
                }

                // Login erfolgreich
                const userData = userDoc.data();
                document.getElementById('loggedInUser').textContent = userData.name || email;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('importSection').style.display = 'block';

            } catch (error) {
                console.error('Login-Fehler:', error);
                let errorMsg = 'Login fehlgeschlagen!';
                if (error.code === 'auth/invalid-credential') {
                    errorMsg = 'E-Mail oder Passwort ung√ºltig!';
                } else if (error.code === 'auth/user-not-found') {
                    errorMsg = 'Benutzer nicht gefunden!';
                } else if (error.code === 'auth/wrong-password') {
                    errorMsg = 'Falsches Passwort!';
                }
                showError(errorMsg);
                loginBtn.disabled = false;
                loginBtn.textContent = 'üîì Als Lehrer anmelden';
            }
        };

        // Haupt-Import-Funktion
        window.startImport = async function() {
            if (!currentUser) {
                showError('Bitte zuerst anmelden!');
                return;
            }
            const btn = document.getElementById('importBtn');
            btn.disabled = true;
            btn.textContent = 'Import l√§uft...';

            try {
                log('üöÄ Starte Import-Prozess...');

                // CSV laden
                log('üì• Lade CSV-Datei...');
                const response = await fetch('Kompetenzen-Lehrplan.csv');
                const csvText = await response.text();
                log('‚úÖ CSV-Datei geladen');

                // CSV parsen
                log('üîç Parse CSV-Daten...');
                const rows = parseCSV(csvText);
                log(`‚úÖ ${rows.length - 1} Zeilen geparst`);

                // Daten strukturieren
                log('üî® Strukturiere Daten...');
                const data = structureData(rows);
                log(`‚úÖ ${data.areas.length} Bereiche, ${data.competencies.length} Kompetenzen, ${data.levels.length} Stufen`);

                // Alte Daten l√∂schen
                await deleteOldData();

                // Neue Daten importieren
                await importData(data);

                log('üéâ Import erfolgreich abgeschlossen!');
                showSuccess(`${data.areas.length} Bereiche, ${data.competencies.length} Kompetenzen und ${data.levels.length} Stufen wurden erfolgreich importiert.`);

                btn.textContent = 'Import abgeschlossen ‚úì';
                btn.style.background = '#48bb78';

            } catch (error) {
                console.error('Import-Fehler:', error);
                log(`‚ùå Fehler: ${error.message}`);
                showError(error.message);
                btn.disabled = false;
                btn.textContent = 'Erneut versuchen';
            }
        };
    </script>
</body>
</html>
