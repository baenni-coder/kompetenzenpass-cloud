rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Hilfsfunktionen
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isStudent() {
      return isAuthenticated() && getUserRole() == 'student';
    }

    function isTeacher() {
      return isAuthenticated() && getUserRole() == 'teacher';
    }

    // ============= BENUTZER =============
    match /users/{userId} {
      // Jeder authentifizierte Benutzer kann sein eigenes Profil lesen
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Jeder authentifizierte Benutzer kann sein eigenes Profil erstellen
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Jeder kann sein eigenes Profil aktualisieren (z.B. lastActive)
      allow update: if isAuthenticated() && request.auth.uid == userId;

      // Lehrer können alle Benutzerprofile lesen und schreiben
      allow read, write: if isAuthenticated() &&
                           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    // ============= KLASSEN =============
    match /classes/{classId} {
      // Alle authentifizierten Benutzer können Klassen lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Klassen erstellen, bearbeiten und löschen
      allow write: if isTeacher();
    }

    // ============= KOMPETENZBEREICHE =============
    match /competencyAreas/{areaId} {
      // Alle authentifizierten Benutzer können Kompetenzbereiche lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Kompetenzbereiche verwalten
      allow write: if isTeacher();
    }

    // ============= KOMPETENZ-GRUPPEN =============
    match /competencies/{competencyId} {
      // Alle authentifizierten Benutzer können Kompetenzen lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Kompetenzen verwalten
      allow write: if isTeacher();
    }

    // ============= KOMPETENZSTUFEN =============
    match /competencyLevels/{levelId} {
      // Alle authentifizierten Benutzer können Kompetenzstufen lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Kompetenzstufen verwalten
      allow write: if isTeacher();
    }

    // ============= INDIKATOREN (NEU) =============
    match /competencyIndicators/{indicatorId} {
      // Alle authentifizierten Benutzer können Indikatoren lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Indikatoren erstellen, bearbeiten und löschen
      allow write: if isTeacher();
    }

    // ============= FORTSCHRITT (BEWERTUNGEN) =============
    match /progress/{userId} {
      // Jeder authentifizierte Benutzer kann seinen eigenen Fortschritt lesen und schreiben
      allow read, write: if isAuthenticated() && request.auth.uid == userId;

      // Lehrer können alle Fortschritte lesen und schreiben
      allow read, write: if isTeacher();
    }

    // ============= ARTEFAKTE (DATEI-UPLOADS) =============
    match /artifacts/{artifactId} {
      // Schüler können ihre eigenen Artefakte lesen und erstellen
      allow read, create: if isAuthenticated() &&
                           request.resource.data.userId == request.auth.uid;

      // Schüler können nur ihre eigenen Artefakte löschen
      allow delete: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Lehrer können alle Artefakte lesen
      allow read: if isTeacher();

      // Lehrer können Artefakte löschen (falls nötig)
      allow delete: if isTeacher();
    }
    
    // USER BADGES (NEU!)
    match /userBadges/{badgeId} {
      // Schüler können ihre eigenen Badges lesen
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      
      // Schüler können ihre eigenen Badges erstellen (automatische Vergabe)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      
      // Lehrer können alle Badges lesen und erstellen
      allow read, create: if isTeacher();
    }
    
    // NEUE RULES FÜR CUSTOM BADGES
match /customBadges/{badgeId} {
  // Alle können Custom Badges lesen
  allow read: if isAuthenticated();
  
  // Nur Lehrer können Custom Badges erstellen
  allow create: if isTeacher();
  
  // Nur der Ersteller kann sein eigenes Badge bearbeiten/löschen
  allow update, delete: if isTeacher() 
                         && resource.data.createdBy == request.auth.uid;
}
// Beispiel-Rules für competencyReviews Collection
match /competencyReviews/{reviewId} {
  allow read: if request.auth != null;
  allow create: if request.auth != null && 
                   request.resource.data.studentId == request.auth.uid;
  allow update: if request.auth != null && 
                   get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
}


  }
}
