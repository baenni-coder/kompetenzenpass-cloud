rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Hilfsfunktionen
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    function isStudent() {
      return isAuthenticated() && getUserRole() == 'student';
    }

    function isTeacher() {
      return isAuthenticated() && getUserRole() == 'teacher';
    }

    // ============= BENUTZER =============
    match /users/{userId} {
      // Jeder authentifizierte Benutzer kann sein eigenes Profil lesen
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Jeder authentifizierte Benutzer kann sein eigenes Profil erstellen
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Jeder kann sein eigenes Profil aktualisieren (z.B. lastActive)
      allow update: if isAuthenticated() && request.auth.uid == userId;

      // Lehrer können alle Benutzerprofile lesen und schreiben
      allow read, write: if isAuthenticated() &&
                           get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'teacher';
    }

    // ============= KLASSEN =============
    match /classes/{classId} {
      // Alle authentifizierten Benutzer können Klassen lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Klassen erstellen, bearbeiten und löschen
      allow write: if isTeacher();
    }

    // ============= KOMPETENZBEREICHE =============
    match /competencyAreas/{areaId} {
      // Alle authentifizierten Benutzer können Kompetenzbereiche lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Kompetenzbereiche verwalten
      allow write: if isTeacher();
    }

    // ============= KOMPETENZ-GRUPPEN =============
    match /competencies/{competencyId} {
      // Alle authentifizierten Benutzer können Kompetenzen lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Kompetenzen verwalten
      allow write: if isTeacher();
    }

    // ============= KOMPETENZSTUFEN =============
    match /competencyLevels/{levelId} {
      // Alle authentifizierten Benutzer können Kompetenzstufen lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Kompetenzstufen verwalten
      allow write: if isTeacher();
    }

    // ============= INDIKATOREN (NEU) =============
    match /competencyIndicators/{indicatorId} {
      // Alle authentifizierten Benutzer können Indikatoren lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Indikatoren erstellen, bearbeiten und löschen
      allow write: if isTeacher();
    }

    // ============= FORTSCHRITT (BEWERTUNGEN & KOMMENTARE) =============
    match /progress/{userId} {
      // Jeder authentifizierte Benutzer kann seinen eigenen Fortschritt lesen und schreiben
      // Enthält: ratings, comments (von Lehrern), pendingReviews
      allow read, write: if isAuthenticated() && request.auth.uid == userId;

      // Lehrer können alle Fortschritte lesen und schreiben
      // Wichtig: Lehrer können comments hinzufügen/ändern
      allow read, write: if isTeacher();
    }

    // ============= FORTSCHRITTS-HISTORIE (NEU - 2025-12-02) =============
    match /progressHistory/{snapshotId} {
      // Schüler können ihre eigene Historie lesen
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Schüler können ihre eigenen Snapshots erstellen (automatisch bei Rating-Änderungen)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Lehrer können alle Historien lesen
      allow read: if isTeacher();

      // Lehrer können Historien erstellen (wenn sie Ratings für Schüler setzen)
      allow create: if isTeacher();
    }

    // ============= ARTEFAKTE (DATEI-UPLOADS) =============
    match /artifacts/{artifactId} {
      // Schüler können ihre eigenen Artefakte lesen und erstellen
      allow read, create: if isAuthenticated() &&
                           request.resource.data.userId == request.auth.uid;

      // Schüler können nur ihre eigenen Artefakte löschen
      allow delete: if isAuthenticated() &&
                     resource.data.userId == request.auth.uid;

      // Lehrer können alle Artefakte lesen
      allow read: if isTeacher();

      // Lehrer können Artefakte löschen (falls nötig)
      allow delete: if isTeacher();
    }
    
    // ============= BADGES & AUSZEICHNUNGEN =============
    // User Badges (verliehene Badges pro Schüler)
    match /userBadges/{badgeId} {
      // Schüler können ihre eigenen Badges lesen
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Schüler können ihre eigenen Badges erstellen (automatische Vergabe durch System)
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Lehrer können alle Badges lesen und erstellen (manuelle Vergabe)
      allow read, create: if isTeacher();
    }

    // Custom Badges (von Lehrern erstellte Badge-Definitionen)
    match /customBadges/{badgeId} {
      // Alle authentifizierten Benutzer können Custom Badges lesen
      allow read: if isAuthenticated();

      // Nur Lehrer können Custom Badges erstellen
      allow create: if isTeacher();

      // Nur der Ersteller kann sein eigenes Badge bearbeiten/löschen
      allow update, delete: if isTeacher() && resource.data.createdBy == request.auth.uid;
    }

    // ============= BEWERTUNGS-ANTRÄGE (REVIEW-SYSTEM) =============
    match /competencyReviews/{reviewId} {
      // Alle authentifizierten Benutzer können Reviews lesen (für Dashboard-Badge)
      allow read: if isAuthenticated();

      // Schüler können nur ihre eigenen Reviews erstellen
      allow create: if isAuthenticated() && request.resource.data.studentId == request.auth.uid;

      // Nur Lehrer können Reviews bearbeiten (approve/reject)
      allow update: if isTeacher();
    }


  }
}
